---
title: "Tidy Tuesday"
date: "WK 29, 2021"
output:
  html_document:  
    df_print: paged
    css: ../css/styles.css
    highlight: tango
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
    number_sections: yes
---

```{r include = FALSE}
rm(list = ls(all = TRUE))

knitr::opts_chunk$set(
	eval = TRUE,
	echo = TRUE,
	include = TRUE,
	message = FALSE,
	warning = FALSE,
	fig.height = 6,
	fig.width = 9.7, # height x 1.618 (golden ratio)
	class.output="style-output",
  class.source="style-source"
)

options(
  rows.print = 15,
  cols.print = 4,
  paged.print = TRUE
)
```

The dataset this week comes from [Kaggle](https://www.kaggle.com/williamschooleman/scoobydoo-complete) and contains all Scooby Doo episodes. More info about Scooby Doo can be found on [ScoobyPedia](https://scoobydoo.fandom.com/wiki/Scoobypedia).

# Setup

```{r}
pacman::p_load(
  tidytuesdayR,
  tidyverse,
  lubridate,
  magrittr,
  glue,
  janitor,
  skimr,
  here
)
```

# Raw Data

Get data and write to local file

```{r eval = FALSE}
tt_load(2021, week = 29) %>% 
  pluck("scoobydoo") %>% 
  write_csv2(here("data.csv"))
```

Read data from local file (`d_raw`)

```{r}
d_raw <- read_csv2(
  here("data.csv"),
  col_types = cols(.default = "c"),
  na = c("NA", "NULL")
)
```

Create working copy (`d`)

```{r}
d <- d_raw
```

# Inspection

```{r}
d
```

```{r}
glimpse(d)
```

## Coltypes

Names of columns that appear logical at first glance

```{r}
# specify columns
col_lgl <- d %>% 
  select(c(
    "arrested",
    "batman",
    "blue_falcon",
    "door_gag",
    "hex_girls",
    "monster_real",
    "non_suspect",
    "scooby_dum",
    "scrappy_doo",
    "trap_work_first",
    starts_with("captured_"),
    starts_with("caught_"),
    starts_with("snack_"),
    starts_with("unmask_")
  )) %>% 
  colnames()
```

Names of columns that appear numeric at first glance

```{r}
# specify columns
col_num <- c(
  "another_mystery",
  "culprit_amount",
  "engagement",
  "groovy",
  "imdb",
  "index",
  "jeepers",
  "jinkies",
  "just_about_wrapped_up",
  "monster_amount",
  "my_glasses",
  "number_of_snacks",
  "rooby_rooby_roo",
  "run_time",
  "scooby_doo_where_are_you",
  "season",
  "set_a_trap",
  "split_up",
  "suspects_amount",
  "zoinks")
```

# Wrangling

## Types

### Date

Parse date from character vector `date_aired`

```{r}
# parse date
d %<>% mutate(aired_date = ymd(date_aired))

# verify result
d %>% 
  select(date_aired, aired_date) %>% 
  slice_sample(n = 15)

# drop original column
d %<>% select(-date_aired)
```

Extract date elements from `aired_date`

```{r}
# get year and month
d %<>% mutate(
  aired_year = year(aired_date),
  aired_month = month(aired_date, label = TRUE)
) 

# get decade
d %<>% mutate(
  aired_decade = glue("{floor(aired_year/10) * 10}s")
) %>% as_factor()

# verify result
d %>% select(
    aired_date,
    aired_year,
    aired_month,
    aired_decade) %>% 
  slice_sample(n = 15)
```

### Logical

Show all unique values in the columns that are presumed to be logical to manually verify this assumption.

```{r}
# print unique values
d %>% 
  select(col_lgl) %>% 
  map(~unique(.x)) %>% 
  flatten_chr() %>% 
  unique()
```

There are indeed no other values than `"TRUE"`/`"FALSE"` or `NA`.

```{r}
# convert to logical
d %<>% mutate(across(col_lgl, as.logical))

# verify result
d %>% select(col_lgl) %>% slice_sample(n = 15)
```

### Numeric

Do the (presumed) numeric columns contain non-numeric characters?

```{r}
# store unique values per column
uniq <- d %>% 
  select(col_num) %>% 
  map(~unique(.x)) 

# identify columns with non-numeric characters
non_num <- uniq %>%
  map( ~ str_detect(.x, "\\D") %>%
         replace_na(FALSE) %>%
         any()) %>%
  flatten_lgl()

# print unique values in columns with non-numeric characters
uniq[non_num]
```

The only non-numeric character in `imdb` is the decimal `.`, so this column can easily be converted to numeric. On the other hand, for `season` and `number_of_snacks` this doesn't make sense.

```{r}
# exclude season and number of snacks
col_num_final <- col_num[!(col_num %in% c("season", "number_of_snacks"))]
```

Keep the original columns (temporarily) for easy verification.

```{r}
# convert to numeric and add suffix
d_num <- d %>% 
  select(all_of(col_num_final)) %>%  
  map_dfr(as.numeric) %>% 
  rename_with( ~ glue("{.x}_num"))

# bind converted data to original data
d %<>% bind_cols(d_num)

# sort columns alphabetically
d %<>% select(sort(colnames(.)))

# verify result
d %>% select(sort(c(
  col_num_final, glue("{col_num_final}_num")
))) %>% slice_sample(n = 15)

# drop old columns and remove suffix from new columns
d %<>%
  select(-(col_num_final)) %>%
  rename_with(~ str_remove(.x, "_num"))
```

## Nesting

Identify character columns containing â‰¥1 comma (might indicate nested data)

```{r}
d_chr <- d %>% select(where(is.character))
d_chr[d_chr %>%
        map( ~ any(str_detect(.x, ","))) %>%
        flatten_lgl() %>%
        replace_na(FALSE)]
```

Create nested list columns where applicable

```{r eval = FALSE}
# note to self: not working, figure out why...
col_nested <-
  c(
    "culprit_gender",
    "culprit_name",
    "monster_gender",
    "monster_name",
    "monster_species",
    "monster_type",
    "monster_subtype"
  )

d %<>% mutate(
  across(
    all_of(col_nested),
      ~ str_squish(str_split(.x, ","))
  )
)
```

```{r}
# the non-elegant -but working- alternative
d$culprit_gender %<>% str_split(",")
d$culprit_name %<>% str_split(",")
d$monster_gender %<>% str_split(",")
d$monster_name %<>% str_split(",")
d$monster_species %<>% str_split(",")
d$monster_type %<>% str_split(",")
d$monster_subtype %<>% str_split(",")
```

## Rename

Rename some columns for consistency and easy sorting
```{r}
# change suffix "_va" into prefix "va_" (voice actor)
d %<>% rename_with( 
  ~ glue("va_{str_remove(.x, '_va')}"), 
  ends_with("_va"))
```

```{r}
# add prefix "appears_" to indicate appearances in episodes
d %<>% rename_with(
  ~ glue("appears_{.x}"),
  c(
    "batman",
    "scooby_dum",
    "scrappy_doo",
    "hex_girls",
    "blue_falcon"
  )
)
```

```{r}
# add prefix "quote_" to counts of words/phrases
d %<>% rename_with(
  ~ glue("quote_{.x}"),
  c(
    "jeepers",
    "jinkies",
    "my_glasses",
    "just_about_wrapped_up",
    "zoinks",
    "groovy",
    "scooby_doo_where_are_you",
    "rooby_rooby_roo"
  )
)
```

```{r}
# sort columns alphabetically
d %<>% select(sort(colnames(.)))
```

## Reshape

Create tidy subsets of the data

### Captured

```{r}
d_captured <- d %>% 
  select(index, starts_with("captured_")) %>% 
  pivot_longer(
    cols = starts_with("captured_"), 
    names_to = "character",
    values_to = "captured") %>% 
  mutate(across(
    "character", 
    ~str_remove(.x, "captured_") %>% str_to_title()
  ))

d_captured %>% head()
```

### Caught

```{r}
d_caught <- d %>% 
  select(index, starts_with("caught_")) %>% 
  pivot_longer(
    cols = starts_with("caught_"), 
    names_to = "character",
    values_to = "caught") %>% 
  mutate(across(
    "character", 
    ~str_remove(.x, "caught_") %>% str_to_title()
  ))

d_caught %>% head()
```

### Unmask

```{r}
d_unmask <- d %>% 
  select(index, starts_with("unmask_")) %>% 
  pivot_longer(
    cols = starts_with("unmask_"), 
    names_to = "character",
    values_to = "unmask") %>% 
  mutate(across(
    "character", 
    ~str_remove(.x, "unmask_") %>% str_to_title()
  ))

d_unmask %>% head()
```

### Snack

```{r}
d_snack <- d %>% 
  select(index, starts_with("snack_")) %>% 
  pivot_longer(
    cols = starts_with("snack_"), 
    names_to = "character",
    values_to = "snack") %>% 
  mutate(across(
    "character", 
    ~str_remove(.x, "snack_") %>% str_to_title()
  ))

d_snack %>% head()
```

### Quote

```{r}
d_quote <- d %>%
  select(index, starts_with("quote_")) %>%
  pivot_longer(
    cols = starts_with("quote_"),
    names_to = "quote",
    values_to = "n") %>%
  mutate(across(
    "quote",
    ~ str_remove(.x, "quote_") %>%
      str_replace_all("_", " ") %>%
      str_to_sentence()
  ))

d_quote %>% head()
```

### Voice Actor

```{r}
d_voice <- d %>%
  select(index, starts_with("va_")) %>%
  pivot_longer(
    cols = starts_with("va_"),
    names_to = "character",
    values_to = "voice") %>%
  mutate(across(
    "character",
    ~ str_remove(.x, "va_") %>%
      str_to_title()
  ))

d_voice %>% head()
```

### Monsters

```{r}
d_monster_type <- d %>% 
  select(index, monster_type) %>% 
  unnest(cols = c(monster_type)) %>% 
  drop_na(monster_type) %>% 
  filter(monster_type != "") %>% 
  mutate(monster_type = str_trim(monster_type)) %>% 
  mutate(monster_type = recode(
    monster_type,
    Disugised = "Disguised",
    Disguise = "Disguised",
    `Possessed Object` = "Possessed"))

d_monster_type %>% head()
```

```{r}
d_monster_subtype <- d %>% 
  select(index, monster_subtype) %>% 
  unnest(cols = c(monster_subtype)) %>% 
  drop_na(monster_subtype) %>% 
  filter(monster_subtype != "") %>% 
  mutate(monster_subtype = str_trim(monster_subtype))

d_monster_subtype %>% head()
```

```{r}
d_monster_species <- d %>% 
  select(index, monster_species) %>% 
  unnest(cols = c(monster_species)) %>% 
  drop_na(monster_species) %>% 
  filter(monster_species != "") %>% 
  mutate(monster_species = str_trim(monster_species))

d_monster_species %>% head()
```

```{r}
d_monster_gender <- d %>% 
  select(index, monster_gender) %>% 
  unnest(cols = c(monster_gender)) %>% 
  drop_na(monster_gender) %>% 
  filter(monster_gender != "") %>% 
  mutate(monster_gender = str_trim(monster_gender))

d_monster_gender %>% head()
```


### Culprits

```{r}
d_culprit <- d %>% 
  select(index, culprit_gender) %>% 
  unnest(cols = c(culprit_gender)) %>% 
  drop_na(culprit_gender) %>% 
  filter(culprit_gender != "") %>% 
  mutate(culprit_gender = str_trim(culprit_gender))

d_culprit %>% head()
```

# Clean Data

Main dataset after cleaning and wrangling.
```{r}
d
```

# Descriptives

## Skim

```{r}
skim(d)
```

## Shows

Number of episodes and movies by decade

```{r}
d %>%
  select(aired_decade, format) %>%
  mutate(format = recode(
    format,
    `TV Series (segmented)` = "TV Series",
    `Movie (Theatrical)` = "Movie"
  )) %>%
  group_by(aired_decade) %>%
  count(format) %>%
  pivot_wider(names_from = format,
              values_from = n) %>%
  mutate(across(
    c("TV Series", "Crossover", "Movie"), 
    ~ replace_na(.x, 0))) %>% 
  rename(Decade = aired_decade)
```

## Rating

IMDb rating by decade

```{r}
d %>% 
  group_by(aired_decade) %>% 
  rstatix::get_summary_stats(imdb) %>% 
  select(-variable)
```

Highest rated show

```{r}
d %>% 
  filter(imdb == max(imdb, na.rm = TRUE)) %>% 
  select(aired_date, format, title, imdb) %>% 
  rename(date = aired_date)
```

Lowest rated show

```{r}
d %>% 
  filter(imdb == min(imdb, na.rm = TRUE)) %>% 
  select(aired_date, format, title) %>% 
  rename(date = aired_date)
```

## Captured

```{r}
d_captured %>% 
  filter(!is.na(captured)) %>% 
  tabyl(character, captured) %>%
  adorn_percentages(denominator = "row") %>%
  arrange(desc(`TRUE`)) %>%
  adorn_pct_formatting() %>%
  select(character, `TRUE`, `FALSE`)
```

## Caught

```{r}
d_caught %>% 
  filter(!is.na(caught)) %>% 
  tabyl(character, caught) %>%
  adorn_percentages(denominator = "row") %>%
  arrange(desc(`TRUE`)) %>%
  adorn_pct_formatting() %>%
  select(character, `TRUE`, `FALSE`)
```

## Unmask

```{r}
d_unmask %>% 
  filter(!is.na(unmask)) %>% 
  tabyl(character, unmask) %>%
  adorn_percentages(denominator = "row") %>%
  arrange(desc(`TRUE`)) %>%
  adorn_pct_formatting() %>%
  select(character, `TRUE`, `FALSE`)
```

## Snack

```{r}
d_snack %>%
  filter(!is.na(snack)) %>%
  tabyl(character, snack) %>%
  adorn_percentages(denominator = "row") %>%
  arrange(desc(`TRUE`)) %>%
  adorn_pct_formatting() %>%
  select(character, `TRUE`, `FALSE`)
```

## Quote

```{r}
d_quote %>% 
  group_by(quote) %>% 
  summarise(total = sum(n, na.rm = TRUE)) %>% 
  arrange(desc(total))
```

## Voice Actor

```{r}
d_voice %>% 
  drop_na(voice) %>% 
  group_by(character) %>% 
  count(voice)
```

## Monsters

### Monster gender

```{r}
d_monster_gender %>% 
  tabyl(monster_gender) %>% 
  arrange(desc(n)) %>% 
  adorn_pct_formatting() %>% 
  rename(gender = monster_gender)
```

### Monster type

Top 10 of most frequent monster types

```{r}
d_monster_type %>% 
  tabyl(monster_type) %>% 
  slice_max(order_by = n, n = 10) %>% 
  adorn_pct_formatting() %>% 
  rename(type = monster_type)
```

### Monster subtype 

Top 10 of most frequent monster subtypes

```{r}
d_monster_subtype %>% 
  tabyl(monster_subtype) %>% 
  slice_max(order_by = n, n = 10) %>% 
  adorn_pct_formatting() %>% 
  rename(subtype = monster_subtype)
```

### Monster species

Top 10 of most frequent monster species

```{r}
d_monster_species %>% 
  tabyl(monster_species) %>% 
  slice_max(order_by = n, n = 10) %>% 
  adorn_pct_formatting() %>% 
  rename(species = monster_species)
```


## Culprits

```{r}
d_culprit %>% 
  tabyl(culprit_gender) %>% 
  arrange(desc(n)) %>% 
  adorn_pct_formatting() %>% 
  rename(gender = culprit_gender)
```

## Motives

```{r}
d %>% 
  drop_na(motive) %>% 
  tabyl(motive) %>% 
  slice_max(order_by = n, n = 10) %>% 
  adorn_pct_formatting()
```

# Visualization

```{r}
ggplot(
  d %>% 
    select(aired_decade, monster_gender) %>%
    unnest(monster_gender) %>%
    group_by(aired_decade, monster_gender) %>%
    filter(monster_gender %in% c("Male", "Female")) %>%
    tally(), 
  aes(
    fill = as.factor(monster_gender),
    y = n,
    x = as.factor(aired_decade)
  )) +
  labs(
    title = "Monsters gender",
    subtitle = "Male and female monsters by decade in Scooby Doo",
    x = "decade aired",
    y = "") +
  geom_bar(position = "fill", stat = "identity", linetype = "blank") +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(
    values = c("Female" = "lightpink", "Male" = "skyblue"), 
    name = "Gender") +
  hrbrthemes::theme_ipsum_rc()
```

```{r}
ggplot(
  d %>% 
    select(aired_decade, culprit_gender) %>% 
    unnest(cols = c(culprit_gender)) %>% 
    drop_na(culprit_gender) %>% 
    filter(culprit_gender != "") %>% 
    mutate(culprit_gender = str_trim(culprit_gender)) %>% 
    group_by(aired_decade, culprit_gender) %>%
    tally(), 
  aes(
    fill = fct_rev(as.factor(culprit_gender)),
    y = n,
    x = fct_rev(as.factor(aired_decade))
  )) +
  labs(
    title = "Culprit gender",
    subtitle = "Male and female culprits by decade in Scooby Doo",
    x = "Decade aired",
    y = "") +
  ggchicklet::geom_chicklet(
    position = position_fill(), 
    radius = grid::unit(5, "pt")) +
  scale_y_continuous(
    labels = scales::percent) +
  scale_fill_manual(
    values = c("Female" = "lightpink", "Male" = "skyblue"), 
    name = "Gender") +
    coord_flip() +
  hrbrthemes::theme_ipsum_rc()
```

```{r}
sort_order <- d_captured %>% 
  filter(captured) %>% 
  count(character) %>% 
  arrange(n) %>% 
  pull(character)

ggplot(
    left_join(d_captured, select(d, index, aired_decade)) %>%
      filter(captured) %>%
      rename(decade = aired_decade) %>%
      group_by(decade, character) %>%
      tally() %>%
      rename(captured = n),
    aes(
      x = fct_relevel(as.factor(character), sort_order), 
      fill = as.factor(decade), 
      y = captured)
  ) +
  ggchicklet::geom_chicklet(radius = grid::unit(5, "pt")) +
  scale_fill_viridis_d(option = "viridis", direction = -1) +
  labs(
    x = "Character",
    y = "Cumulative count",
    title = "Captured",
    subtitle = "By character and decade",
    caption = "Created by Philomenix",
    fill = "Decade") +
  coord_flip() +
  hrbrthemes::theme_ipsum_rc()
```

```{r}
sort_order <- d_caught %>% 
  filter(caught & !(character %in% c("Not", "Other"))) %>% 
  count(character) %>% 
  arrange(n) %>% 
  pull(character)

ggplot(
    left_join(d_caught, select(d, index, aired_decade)) %>%
      filter(caught) %>%
      filter(!(character %in% c("Not", "Other"))) %>% 
      rename(decade = aired_decade) %>%
      group_by(decade, character) %>%
      tally() %>%
      rename(caught = n),
    aes(
      x = fct_relevel(as.factor(character), sort_order), 
      fill = as.factor(decade), 
      y = caught)
  ) +
  ggchicklet::geom_chicklet(radius = grid::unit(5, "pt")) +
  scale_fill_viridis_d(option = "viridis", direction = -1) +
  labs(
    x = "Character",
    y = "Cumulative count",
    title = "Caught",
    subtitle = "By character and decade",
    caption = "Created by Philomenix",
    fill = "Decade") +
  coord_flip() +
  hrbrthemes::theme_ipsum_rc()
```

